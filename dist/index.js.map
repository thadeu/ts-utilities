{"version":3,"file":"index.js","sources":["../src/Exception.ts","../src/Util.ts","../src/index.ts"],"sourcesContent":["export class TryException extends Error {\n  statusCode: number\n\n  constructor(message: string, statusCode?: number) {\n    super(message)\n\n    this.name = 'TryException'\n    this.statusCode = statusCode || 400\n\n    Error.captureStackTrace(this, this.constructor)\n  }\n}\n","export const isFunction = fn => fn?.constructor?.name === 'Function'\nexport const isAsyncFunction = fn => fn?.constructor?.name === 'AsyncFunction'\nexport const isPlainRegex = input => input.constructor?.name === 'RegExp'\nexport const isPlainString = input => typeof input === 'string' && input.trim()\n\nexport const execute = (o, params = null) => {\n  if (isAsyncFunction(o)) {\n    return o(params)\n  }\n\n  if (isFunction(o)) {\n    return o(params)\n  }\n\n  return (() => o)()\n}\n\nexport const delay = ms => new Promise((resolve, reject) => setTimeout(resolve, ms))\n\nexport const race = (milliseconds, ...promises) => {\n  const timeout = new Promise((resolve, reject) => {\n    setTimeout(() => reject(`limit time excedded (${milliseconds} ms)`), milliseconds)\n  })\n\n  return Promise.race([timeout, ...promises])\n}\n","import { TryException } from '@/Exception'\nimport { execute, delay, race, isFunction, isAsyncFunction, isPlainString, isPlainRegex } from '@/Util'\n\nexport { delay, race, isAsyncFunction, isFunction, isPlainString, isPlainRegex, execute as Execute }\n\ninterface TryOptions {\n  max?: number\n  exponential?: number\n  count?: number\n  strict?: boolean\n  timeout?: number\n  onError?: any\n  async?: boolean\n  onRetry?: (count: number, isReached: boolean) => void\n}\n\nexport function safetry<E = Error, T = any>(callable: any, options?: TryOptions): [E, T] | any {\n  return safeTry(callable, options)\n}\n\nexport function safeTry<E = Error, T = any>(callable: any, options?: TryOptions): [E, T] | any {\n  const max = options?.max ?? 0\n  const isAsync = options?.async ?? isAsyncFunction(callable)\n  let count = options?.count ?? 0\n\n  try {\n    if (isAsync) {\n      return race(options?.timeout ?? 9_999, execute(callable))\n        .then(res => {\n          return [null, res]\n        })\n        .catch(e => {\n          if (count >= max) {\n            if (options?.onError) return [options.onError(e), null]\n\n            return [e, null]\n          }\n\n          count++\n\n          if (options?.onRetry) options.onRetry(count, count >= max)\n\n          return Try(callable, { ...options, count })\n        })\n    }\n\n    if (isFunction(callable)) {\n      return [null, execute(callable)]\n    }\n\n    return [null, execute(callable)]\n  } catch (error) {\n    if (count >= max) {\n      if (options?.strict) {\n        throw new TryException(error)\n      } else {\n        if (options?.onError) return [options.onError(error), null]\n\n        return [error, null]\n      }\n    }\n\n    count++\n\n    if (options?.onRetry) options.onRetry(count, count >= max)\n\n    if (max > 0) {\n      return (async function () {\n        await delay(count ** (options?.exponential ?? 1.5) * 1_000)\n\n        return Try(callable, { ...options, count })\n      })()\n    }\n\n    return Try(callable, { ...options, count })\n  }\n}\n\nexport function Try(callable: any, options?: TryOptions) {\n  const max = options?.max ?? 0\n  const isAsync = options?.async ?? isAsyncFunction(callable)\n  let count = options?.count ?? 0\n\n  try {\n    if (isAsync) {\n      return race(options?.timeout ?? 9_999, execute(callable)).catch(e => {\n        if (count >= max) {\n          return options?.onError ? execute(options?.onError, e) : e\n        }\n        \n        count++\n        \n        if (options?.onRetry) options.onRetry(count, count >= max)\n          \n          if (max > 0) {\n          return (async function () {\n            await delay((count ** (options?.exponential ?? 0.5)) * 1_000)\n            return Try(callable, { ...options, count })\n          })()\n        }\n\n        return Try(callable, { ...options, count })\n      })\n    }\n\n    if (isFunction(callable)) {\n      return execute(callable)\n    }\n\n    return execute(callable)\n  } catch (error) {\n    if (count >= max) {\n      if (options?.strict) {\n        throw new TryException(error)\n      } else {\n        return execute(options?.onError, error)\n      }\n    }\n\n    count++\n\n    if (options?.onRetry) options.onRetry(count, count >= max)\n\n    if (max > 0) {\n      return (async function () {\n        await delay((count ** (options?.exponential ?? 0.5)) * 1_000)\n        return Try(callable, { ...options, count })\n      })()\n    }\n\n    return Try(callable, { ...options, count })\n  }\n}\n"],"names":["TryException","_Error","message","statusCode","_this","call","this","name","Error","captureStackTrace","_assertThisInitialized","constructor","_wrapNativeSuper","isFunction","fn","_fn$constructor","isAsyncFunction","_fn$constructor2","execute","o","params","delay","ms","Promise","resolve","reject","setTimeout","race","milliseconds","timeout","concat","slice","arguments","safeTry","callable","options","_options$max","_options$async","_options$count","max","isAsync","async","count","_options$timeout","then","res","e","onError","onRetry","Try","_extends","error","strict","_options$exponential","Math","pow","exponential","_options$max2","_options$async2","_options$count2","_options$timeout2","_options$exponential2","_options$exponential3","input","_input$constructor","trim"],"mappings":"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"}